name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint (ruff)
        run: ruff check dashboard/ sre-brain/ chaos-scripts/ vm-image/

      - name: Format (ruff)
        run: ruff format --check dashboard/ sre-brain/ chaos-scripts/ vm-image/

      - name: Type check (mypy)
        run: |
          pip install mypy
          mypy dashboard/ sre-brain/ --ignore-missing-imports --no-error-summary 2>/dev/null || true

      - name: Bandit (Python SAST)
        run: |
          pip install bandit
          bandit -r dashboard/ sre-brain/ chaos-scripts/ vm-image/ -ll --skip B101

      - name: Test
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/chaos-scripts:$(pwd)/dashboard:$(pwd)/vm-image"
          pytest tests/ -v --cov=dashboard --cov=sre-brain --cov=chaos-scripts --cov=vm-image --cov-fail-under=0 --cov-report=term-missing --cov-report=xml

      - name: Upload coverage (Codecov)
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

      - name: Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Secret Scanning (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform Init
        run: cd infra && terraform init -input=false

      - name: Terraform Fmt
        run: cd infra && terraform fmt -check -recursive

      - name: Terraform Validate
        run: cd infra && terraform validate

      - name: Terraform Security (tfsec)
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra
          soft_fail: true
